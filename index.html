<meta charset="utf-8">
<!--
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
-->

<style>
	* {
		font-family: sans-serif;
		font-size: 14;
	}

	.svg {
		background-color: #555;
		display: inline-block;
		margin: auto;
		text-align: center;
	}

	span.info {
		font-style: normal;
		font-size: 12px;
	}

	p {
		margin-bottom: .5rem;
	}

	#chart {
		padding: 20px;
	}

	#infotron {
		padding: 20px;
		line-height: 1.2rem;
	}

	.axis path{
	  stroke: #444;
	}

	.axis text{
		font-size: 14;
		fill: #fff;
	}	
	}
</style>

<body>
<!-- External stuff -->
<script src="d3.min.js"></script>
<script src="graph2.js"></script>
<script src="imperative.js"></script>
<script src="structured.js"></script>
<script src="lisp.js"></script>
<script src="logical.js"></script>
<script src="coop.js"></script>
<script src="oop.js"></script>
<script src="other.js"></script>
<script src="unix.js"></script>
<script src="dynamic.js"></script>
<script src="ml.js"></script>
<script src="graph.js"></script>

<div id="chart" class="container">
	<svg id="svg"></svg>
</div>

<div id="infotron" class="container"></div>

<!-- info box -->
<script>
	var render = ( node )=> {
		let txt = `<p style="text-align: center">`

		// name, date
		+ `<span style="font-size: 24px">` + node.name + `</span>`
		+ `</p><p style="text-align: center">`

		// date, developers, organization, web page
		+ `<span class="info" style="font-size: 11px;">`
		+ node.date
		+ ` | ` + node.dev
		+ ` | ` + node.org
		+ ` | <a href=` + node.www + `>www</a>`
		+ `</p><p>`		

		// characteristics and contributions
		+ `<span style="font-size: 8px;">(characteristics) `
		+ `<span style="font-size: 11px;">` + node.characteristics + `</span>`
		+ `</p><p>`

		+ `<span style="font-size: 8px;">(contributions) `
		+ `<span style="font-size: 11px;">` + node.contributions + `</span> `
		+ `</p><p>`

		+ `<span style="font-size: 8px;">(comments) `
		+ `<span style="font-size: 11px;">` + node.comments + `</span>`
		+ "</p>";

		return txt
	}

	var report = ( node )=> {
		document.getElementById( "infotron" ).innerHTML = render( node )
	}
</script>

<!-- graph -->
<script>

// CANVAS
var width = 1000;
var height = 500;


var svg = d3.select( '#svg' )
	.attr( 'width', width )
	.attr( 'height', height )
	.attr( 'class', 'svg' )

// CONTAINER
var viewSet = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
var viewLevel = 0

// GRAPH
var graph = filterLane( graphAll, viewSet )

function click( node ){
	d3.event.stopPropagation()	
	svg.selectAll( '*' ).remove()

	if( viewLevel === 0 ){
		graph = filterLane( graphAll, [ node.tags.lane ])		
		viewLevel = 1
	} else if( viewLevel === 1 ){
		graph = filterNode( graph, node )
		viewLevel = 2
	} else {
		graph = filterLane( graphAll, viewSet )
		viewLevel = 0
	}

	draw( graph )
}

function draw( graph ){

	// BACKGROUND
	svg.append( 'rect' )
		.attr( 'class', 'overlay' )
		.attr( 'fill', '#222' )
		.attr( 'width', width )
		.attr( 'height', height )
		.on( 'click', ()=> {
			graph = filterLane( graphAll, viewSet )
			viewLevel = 0
			draw( graph )
		})

	var container = svg
		.append( 'g' )
		.attr( 'width', width - 500 )
		.attr( 'height', height - 200 )

	// Zooming
	var zoom = d3.zoom().on("zoom", zoomed).scaleExtent([1 / 2, 8]);

	function zoomed() {
		container.attr("transform", d3.event.transform); // updated for d3 v4
	}

	svg.call( d3.zoom()
				.on( "zoom", ()=> {
					let x = ( width / 2 ) * .1
					let y = ( height / 2 ) * .1
					let k = .9
					container.attr( "transform", `translate(${x}, ${y})scale(${k})` )
				}))
		.call( zoom.transform, d3.zoomIdentity.translate( ( width / 2 ) * .1, ( height / 2 ) * .1 ).scale( .9 ))

	// LAYOUT (via force-based physics simulation, yikes!)
	if( viewLevel === 1 ){ repulsion = 75 }
	else { repulsion = 30 }

	var simulation = d3.forceSimulation( graph.nodes )
		.force( "link", d3.forceLink()
			.id( d => { return d })
			.links( graph.links )
			.strength( 0.01 ))
		.force( "charge", d3.forceManyBody() )
		.force( "collision", d3.forceCollide().radius( repulsion ))
		.force( 'x', d3.forceX().x( d => timeline( d )))
		.force( 'y', d3.forceY().y( d => lane( d )))
		.on( "tick", ticked );

	// X axis
	var x = d3.scaleTime()
		.domain([
			new Date( graph.years.min, 0, 1 ),
			new Date( graph.years.max, 0, 1 )])
		.range([ 0, width ])
	var xAsix = container.append( 'g' )
		.attr( 'class', 'axis' )
		.attr( 'transform',
				'translate(0,' + height + ')')
		.call( d3
			.axisBottom( x ))

	function timeline( d ){
		let range = graph.years.max - graph.years.min
		let position = d.date - graph.years.min
		return 50 + ( position / range ) * ( width - 100 )
	}

	// Y axis
	function lane( d ){
		let range = graph.lanes.length + 2
		let position = graph.lanes.indexOf( d.tags.lane ) + 1
		return 50 + ( position / range ) * ( height - 50 )
	}

	// LINK
	var links = container.append( 'g' ).attr( 'class', 'links' )
		.selectAll( 'line' )
		.data( graph.links )
		.enter()
		.append( 'line' )
			.attr( 'stroke', '#444' )

	function updateLink( link ){
		link.attr( "x1", ( d )=>{ return d.source.x; })
			.attr( "y1", ( d )=>{ return d.source.y; })
			.attr( "x2", ( d )=>{ return d.target.x; })
			.attr( "y2", ( d )=>{ return d.target.y; });
	}

	// NODE
	// build
	var nodes = container.append( 'g' ).attr( 'class', 'nodes' )
		.selectAll( 'circle' )
		.data( graph.nodes )
		.enter()
		.append( 'ellipse' )
			.attr( 'rx', ovalWidth )
			.attr( 'ry', 20 )
			.attr( 'fill', palette )
			.attr( 'stroke', 'black' )

	// mouse
	nodes.on( 'mouseover', focus )
	nodes.on( 'mouseout', unfocus )
	nodes.on( 'click', click )

	// render
	function updateNode( node ){
		node.attr( "transform", d => {
			return "translate(" + d.x + "," + d.y + ")";
		})
	}

	function focus( node ){
		report( node )
		d3.select( event.currentTarget )
			.attr( "rx", ovalWidth( node ) + 10 )
			.attr( "ry", 30 )
			.attr( 'stroke', 'gray' )
	}

	function unfocus( node ){
		d3.select( event.currentTarget )
			.attr( "rx", ovalWidth )
			.attr( "ry", 20 )
			.attr( 'stroke', 'black' )
	}

	function palette( node, graph ){
		let color = '#aaa'
		if( 'tags' in node ){
			color = node.tags.color
		}

		for( active in graph.active ){
			if( node == active ){
				node.attr( 'fill', '#fff' )
			}
		}

		return color
	}

	function ovalWidth( node ){
		return 20 + ( node.name.length * 2 )
	}

	// LABEL
	var labels = container.append( 'g' ).attr( 'class', 'label' )
		.selectAll( 'node' )
		.data( graph.nodes )
		.enter()
		.append( 'text' )
			.text( d => { return d.name })
			.style( 'fill', 'white' )
			.style( 'text-shadow', '1px 1px 2px black' )
			.style( 'font-family', 'Arial' )
			.style( 'font-size', 10 )
			.style( 'font-style', 'bold' )
			.style( 'text-anchor', 'middle' )
			.style( 'pointer-events', 'none' )

	function updateLabel( label ){
		label.attr( "transform", d => {
			return "translate(" + d.x + "," + d.y + ")";
		})
	}

	// TICKS
	function ticked() {
		nodes.call( updateNode );
		labels.call( updateLabel );
		links.call( updateLink );
	}
}

draw( graph )

</script>
</body>


